<!DOCTYPE html>
<html>
<head>
  <style>
    html,
    body {
      margin: 0;
      overflow: hidden;
      height: 100%;
      background: black;
    }

    canvas[resize] {
      width: 100%;
      height: 100%;
    }
  </style>

  <script type="text/javascript" src="js/paperjs-v0.10.2/dist/paper-full.js"></script>
  <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
  <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
  <script type="text/javascript" src="js/hacknode_graphics.js"></script>
  
  <script type="text/javascript">
      paper.install(window);

      var socket = io('http://localhost:7000');
      socket.emit('message', "/user user1 password");

      var nodes = new Map();
      var connections = new Map();


      // Only execute our code once the DOM is ready.
      window.onload = function () {
          
          // Get a reference to the canvas object
          var canvas = document.getElementById('myCanvas');
          // Create an empty project and a view for the canvas:
          paper.setup(canvas);

          // TODO: eliminate makeNode
          function makeNode(x, y, size, color) {
              var node = new Node(x, y, size, color);
              console.log(x, y, size, color);

              node.onMouseDown = function (event) {
                  if (this.owned) {
                      // if this is a node we own, allow selection or deselection
                      this.selected = !(this.selected);
                  }
              } // end onMouseDown
              return node;
          } // end MakeNode

          socket.emit('sync', 'all');

          socket.on('sync', function (msg) {
              console.log("got sync");

              // parse the JSON into an object
              var network = JSON.parse(msg);
              console.log(network);
              console.log(network.description);
              console.log("Number of nodes in network: " + network.nodes.length);

              // loop through the nodes in the network object and create them
              for(i=0;i< network.nodes.length;i++){
                  var node = network.nodes[i];
                  nodes.set(node.id, makeNode(node.x, node.y, node.r, node.baseColor));
              }

              // loop through the connections in the network object and create them
              for (i = 0; i < network.connections.length; i++) {
                  var connection = network.connections[i];
                  node1 = nodes.get(connection.node1); //findNode(connection.node1);
                  node2 = nodes.get(connection.node2); //findNode(connection.node2);
                  if(node1 != null && node2 != null) {
                      connections.set(connection.id, connectNodes(node1, node2));
                  }
              }

          }); // end on sync

          socket.on('error_message', function (msg) {
            console.log("socket error: " + msg);
          });

          view.onFrame = function (event) {
              // event.count is the number of times the frame event has been fired
              if (event.count % 60 == 0) { // 60 frames per second

              } // end if
          } //end onFrame

          // Draw the view now:
          view.draw();
          
      } //end OnLoad
  </script>
</head>

<body>
<canvas id="myCanvas" resize></canvas>
</body>
</html>
